(function(b,a){if(typeof require==="function"&&typeof module==="object"&&module&&typeof exports==="object"&&exports){module.exports=a()}else{if(typeof define==="function"&&define.amd){define(a)}else{b.Ljstore=b.Ljstore||a(b)}}}(this,(function(x){var t=/^\[object (\S+)\]$/,w=Object.prototype.toString,v=Array.prototype.slice,e=function(){},D=document,f=D.getElementsByTagName("head")[0],m=D.getElementsByTagName("body")[0],z=x.localStorage;function y(F){var E=typeof F;if(E!=="object"){return E}return w.call(F).replace(t,"$1").toLowerCase()}function l(E){return y(E)==="object"}function n(E){return y(E)==="array"}function q(E){return y(E)==="string"}function b(E){var F=E.match(/\.(\w+)(\?.+)?$/i);return F?F[1]:F}function p(F,G){for(var E in G){if(G.hasOwnProperty(E)){F[E]=G[E]}}}function B(G){var E=null;if(l(G)){E={};for(var F in G){if(l(G[F])||n(G[F])){E[F]=B(G[F]);continue}E[F]=G[F]}}else{if(n(G)){E=[];G.forEach(function(I,H){if(l(I)||n(I)){E[H]=B(I);return}E[H]=I})}else{E=G}}return E}function g(I,H,G){if(G===void 0){G=false}if(!l(I)||!l(H)){return}var E=B(I);for(var F in H){if(!E.hasOwnProperty(F)){E[F]=B(H[F])}else{E[F]=G?B(H[F]):E[F]}}return E}function k(E){if(/<\/?[^>]*>/g.test(E)){return false}var F="^(((https|http|ftp|rtsp|mms):)+//)+(([0-9a-z_!~*'().&=+$%-]+: )?[0-9a-z_!~*'().&=+$%-]+@)?(([0-9]{1,3}.){3}[0-9]{1,3}|([0-9a-z_!~*'()-]+.)*([0-9a-z][0-9a-z-]{0,61})?[0-9a-z].[a-z]{2,6})?(:[0-9]{1,4})?([^?#]+)?(\\?[^#]+)?(#.+)?$";return new RegExp(F).test(E)}function c(G,F,I){I=I||window;var J;for(var H=0,E=G.length;H<E;H++){J=G[H];if(F.call(I,J,H,G)){return H}}return -1}function i(G,I){var J={},F=[];for(var H=0,E=G.length;H<E;H++){if(!J[G[H][I]]){J[G[H][I]]=true;F.push(G[H])}}return F}function d(E,I,J,H){J=J||function(){};E=E||[];H=H||null;if(!E.length){return J()}var G=0;E.forEach(function(L,K){I.call(H,L,K,F)});function F(K){G++;if(K){return J.call(H,K)}if(G===E.length){J.call(H)}}}function h(E,J,K,H){K=K||function(){};E=E||[];H=H||null;var G=-1;I();function I(){if(++G===E.length){return K.call(H)}J.call(H,E[G],G,F)}function F(L){if(L){return K.call(H,L)}I()}}function j(E,G,F){if(!E||typeof E!=="function"){return}if(!G){G=5000}F=F||window;return function(){var H=[].slice.call(arguments),I=H.shift();if(!I||typeof I!=="function"){return E.call(F)}var J=Date.now(),K=setTimeout(function(){I("TIMEOUT");I=null;clearTimeout(K);K=null},G);H.push(function(){clearTimeout(K);K=null;if(!I){return}I(null)});return E.apply(F,H)}}var s=(function(){var G,E=0,F={};function H(N,O){var M=D.createElement("script"),K=false;M.src=N;M.async=true;var L=O||F.error;if(typeof L==="function"){M.onerror=function(P){L({url:N,event:P})}}M.onload=M.onreadystatechange=function(){if(!K&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){K=true;M.onload=M.onreadystatechange=null;if(M&&M.parentNode){M.parentNode.removeChild(M)}}};if(!G){G=D.getElementsByTagName("head")[0]}G.appendChild(M)}function I(L,P,Q,O){var N=(L||"").indexOf("?")===-1?"?":"&",M;O=(O||F.callbackName||"callback");var K=O+"_json"+(++E);if(typeof P==="function"){Q=P;P={}}P=P||{};for(M in P){if(P.hasOwnProperty(M)){N+=encodeURIComponent(M)+"="+encodeURIComponent(P[M])+"&"}}window[K]=function(R){Q(R);try{delete window[K]}catch(S){}window[K]=null};H(L+N+O+"="+K);return K}function J(K){F=K}return{get:I,init:J}}());function A(G,I,H){if(G==="css"){var F=D.createElement("style");F.innerText=H;F.id=I;f.appendChild(F)}else{var E=D.createElement("script");E.text=H;E.id=I;E.defer=true;m.appendChild(E)}}function a(E){if(q(E)){return z.getItem(E)?JSON.parse(z.getItem(E)):null}if(n(E)){return E.map(function(F){return z.getItem(F)?JSON.parse(z.getItem(F)):z.getItem(F)})}return null}function o(E,F){if(!l(F)){return}z.setItem(E,JSON.stringify(F))}function r(E){if(q(E)){return z.removeItem(E)}if(n(E)){return E.forEach(function(F){return z.removeItem(F)})}}function u(F){var E=0,H=[];while(x.localStorage.key(E)){var G=x.localStorage.key(E);if(new RegExp(F).test(G)){H.push(G)}E++}return H}var C=function(E){E=E||{};if(!l(E)){throw new Error("Parameter 1 must be the object type");return}this._sources=[];this.prefix="ljstore_";this.supportExt=["js","css"];this._config={timeout:60000,expireTime:null};this._listeners={};p(this._config,E);s.init({callbackName:"callback",error:function(F){this.emit("error","[network error] "+F.url+" has a error")}.bind(this)})};C.prototype.add=function(F){if(!n(F)){if(l(F)){F=[F]}else{return}}F=i(F,"key");var G=function(I){var H=g(this._config,I,true);H.key=this.prefix+(H.key||H.url);H.key+="@"+(x[H.key]||"");H.ext=b(H.url);H.stime=Date.now();if(!~this.supportExt.indexOf(H.ext)){throw new Error("invalid file type");return}return H};var E=function(H){if(!H.key||!/^[a-zA-z0-9_]+$/.test(H.key)){throw new Error("invalid key");return}if(!H.url||!k(H.url)){throw new Error("invalid url")}this._sources.push(G.call(this,H))};F.forEach(function(H){E.call(this,H)},this)};C.prototype.load=function(I,G){I=!!I;G=G||e;var J=this;if(I){var F=[],E=[];this._sources.forEach(function(K){var L=H(K);if(L){E.push({content:L,id:K.key,ext:K.ext})}else{E.push(K.key);F.push(K)}});if(F.length){d(F,function(M,K,L){var N=j(function(O){s.get(M.url,function(P){O();var Q=E.indexOf(M.key);if(Q!==-1){E.splice(Q,1,{ext:M.ext,id:M.key,content:P.content})}M.content=P.content;r(u(M.key.split("@")[0]));o(M.key,M);L()})},5000);N(function(O){if(O&&O==="TIMEOUT"){J.emit("error","[network timeout] "+M.url+" timed out");L()}})},function(){E.forEach(function(K){A(K.ext,K.id,K.content)});this._sources=[];G()},this)}else{E.forEach(function(K){A(K.ext,K.id,K.content)});this._sources=[];G()}}else{d(this._sources,function(N,L,M){var K=H(N);if(K){A(N.ext,N.key,K)}else{var O=j(function(P){s.get(N.url,function(Q){P();A(N.ext,N.key,Q.content);N.content=Q.content;r(u(N.key.split("@")[0]));o(N.key,N);M()})},5000);O(function(P){if(P&&P==="TIMEOUT"){J.emit("error","[network timeout] "+N.url+" timed out");M()}})}},function(){this._sources=[];G()},this)}function H(M){var N=a(M.key),K=Date.now(),L=M.expireTime*60*1000;return(N&&N.url===M.url&&K<(M.stime+L))?N.content:null}};C.prototype.insert=function(F,E){E=E||e;if(!n(F)){if(l(F)){F=[F]}else{return}}this.add(F);if(this._sources.length===1){this.load(false,function(){E()})}};C.prototype.on=function(E,F){if(typeof this._listeners[E]!=="undefined"){this._listeners[E].push(F)}else{this._listeners[E]=[F]}};C.prototype.emit=function(F,G){if(typeof this._listeners[F]!=="undefined"){for(var E=0;E<this._listeners[F].length;E++){try{this._listeners[F][E].call(this,G)}catch(H){console.log(H.stack)}}}};return C})));